"use strict";
var __awaiter = (this && this.__awaiter) || function (thisArg, _arguments, P, generator) {
    return new (P || (P = Promise))(function (resolve, reject) {
        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }
        function rejected(value) { try { step(generator["throw"](value)); } catch (e) { reject(e); } }
        function step(result) { result.done ? resolve(result.value) : new P(function (resolve) { resolve(result.value); }).then(fulfilled, rejected); }
        step((generator = generator.apply(thisArg, _arguments || [])).next());
    });
};
Object.defineProperty(exports, "__esModule", { value: true });
const AWS = require("aws-sdk");
const chai_1 = require("chai");
require("mocha");
const sinon = require("sinon");
const awsS3Module_1 = require("../src/awsS3Module");
const azureDataLakeModule_1 = require("../src/azureDataLakeModule");
const redisModule_1 = require("../src/redisModule");
const s3ToAdlDataCopy_1 = require("../src/s3ToAdlDataCopy");
describe("aws s3 tests", () => {
    let s3ToAdl;
    let adlModule;
    let awsS3Module;
    let redisModule;
    const expectedElement1 = {
        ETag: "123456",
        Key: "file1",
    };
    const expectedElement2 = {
        ETag: "123457",
        Key: "file2",
    };
    beforeEach(function () {
        process.env["AWS_ACCESS_KEY_ID"] = "key";
        process.env["AWS_SECRET_ACCESS_KEY"] = "secretkey";
        process.env["AWS_REGION"] = "region";
        process.env["AWS_BUCKET_NAME"] = "bucket";
        process.env["AZURE_CLIENT_ID"] = "client";
        process.env["AZURE_DOMAIN"] = "domain";
        process.env["AZURE_SECRET"] = "secret";
        process.env["AZURE_ADL_ACCOUNT_NAME"] = "account";
        process.env["TEMP_FOLDER"] = "./tempFolder";
        process.env["USE_REDIS"] = "false";
        const bucketName = "bucket";
        const tempFolder = "tempFolder";
        awsS3Module = new awsS3Module_1.AwsS3Module(bucketName, tempFolder, new AWS.S3());
        adlModule = new azureDataLakeModule_1.AzureDataLakeModule("accountName", "folderName", null);
    });
    it("When required environment variables are missing exception is thrown", () => {
        // given
        delete process.env["AZURE_ADL_ACCOUNT_NAME"];
        // act
        try {
            s3ToAdl = new s3ToAdlDataCopy_1.S3ToAdlDataCopy();
        }
        catch (ex) {
            // assert
            chai_1.expect(ex.message).to.equal("Environment Variable AZURE_ADL_ACCOUNT_NAME is not defined");
        }
    });
    it("When USE_REDIS is set to other variable then true/false exception is thrown", () => {
        // given
        process.env["USE_REDIS"] = "some value";
        // act
        try {
            s3ToAdl = new s3ToAdlDataCopy_1.S3ToAdlDataCopy();
        }
        catch (ex) {
            // assert
            chai_1.expect(ex.message).to.equal("Environment Variable USE_REDIS should contain boolean value");
        }
    });
    it("batchIterationOverS3Items doesn't uploads file when it's already exists", () => __awaiter(this, void 0, void 0, function* () {
        // given
        sinon.stub(awsS3Module, "listAllObjects").returns({
            Contents: [expectedElement1, expectedElement2],
        });
        const uploadToAdlStub = sinon.stub(adlModule, "shouldUploadToADL").returns(new Promise((resolve) => {
            resolve(false);
        }));
        const awsSpy = sinon.spy(awsS3Module, "downloadFileFromS3");
        // act
        s3ToAdl = new s3ToAdlDataCopy_1.S3ToAdlDataCopy();
        yield s3ToAdl.batchIterationOverS3Items(awsS3Module, adlModule, null);
        // assert
        chai_1.expect(awsSpy.callCount).to.equal(0);
        chai_1.expect(uploadToAdlStub.callCount).to.equal(2);
    }));
    it("batchIterationOverS3Items uploads the missing file in ADL", () => __awaiter(this, void 0, void 0, function* () {
        // given
        sinon.stub(awsS3Module, "listAllObjects").returns({
            Contents: [expectedElement1, expectedElement2],
        });
        let downloadStub = sinon.stub(awsS3Module, "downloadFileFromS3").returns(new Promise((resolve) => resolve()));
        sinon.stub(adlModule, "uploadFileToAzureDataLake").returns(new Promise((resolve) => resolve()));
        const uploadStub = sinon.stub(adlModule, "shouldUploadToADL");
        uploadStub.withArgs(expectedElement1).returns(new Promise((resolve) => {
            resolve(false);
        }));
        uploadStub.withArgs(expectedElement2).returns(new Promise((resolve) => {
            resolve(true);
        }));
        // act
        s3ToAdl = new s3ToAdlDataCopy_1.S3ToAdlDataCopy();
        yield s3ToAdl.batchIterationOverS3Items(awsS3Module, adlModule, null);
        // assert
        chai_1.expect(downloadStub.callCount).to.equal(1);
        chai_1.expect(uploadStub.callCount).to.equal(2);
    }));
    it("batchIterationOverS3Items when error is thrown while uploading file iteration continues as expected", () => __awaiter(this, void 0, void 0, function* () {
        // given
        sinon.stub(awsS3Module, "listAllObjects").returns({
            Contents: [expectedElement1, expectedElement2],
        });
        let downloadStub = sinon.stub(awsS3Module, "downloadFileFromS3").returns(new Promise((resolve) => resolve()));
        let uploadStub = sinon.stub(adlModule, "uploadFileToAzureDataLake");
        uploadStub.withArgs(expectedElement1.Key).throws(new Error());
        uploadStub.withArgs(expectedElement2.Key).returns(new Promise((resolve) => resolve()));
        const shouldUploadStub = sinon.stub(adlModule, "shouldUploadToADL").returns(new Promise((resolve) => {
            resolve(true);
        }));
        // act
        s3ToAdl = new s3ToAdlDataCopy_1.S3ToAdlDataCopy();
        yield s3ToAdl.batchIterationOverS3Items(awsS3Module, adlModule, null);
        // assert
        chai_1.expect(downloadStub.callCount).to.equal(2);
        chai_1.expect(shouldUploadStub.callCount).to.equal(2);
        // expect only one since the second thrown an error
        chai_1.expect(s3ToAdl.copyProperties.uploadedCount).to.equal(1);
    }));
    it("shouldUploadFile return false when using redis and file exist on ADL", () => __awaiter(this, void 0, void 0, function* () {
        // given
        process.env["USE_REDIS"] = "true";
        const redisObj = new redisModule_1.RedisObject();
        redisObj.ETag = expectedElement1.ETag;
        redisModule = new redisModule_1.RedisModule(null);
        const shouldUploadStub = sinon.stub(redisModule, "isFileInRedis").returns(new Promise((resolve) => {
            resolve(redisObj);
        }));
        // act
        s3ToAdl = new s3ToAdlDataCopy_1.S3ToAdlDataCopy();
        let shouldUpload = yield s3ToAdl.shouldUploadFile(redisModule, adlModule, expectedElement1);
        // assert
        chai_1.expect(shouldUploadStub.callCount).to.equal(1);
        // expect only one since the second thrown an error
        chai_1.expect(shouldUpload).to.equal(false);
    }));
    it("shouldUploadFile return true when using redis and file is missing from ADL", () => __awaiter(this, void 0, void 0, function* () {
        // given
        process.env["USE_REDIS"] = "true";
        const redisObj = new redisModule_1.RedisObject();
        redisObj.ETag = "6543321";
        redisModule = new redisModule_1.RedisModule(null);
        const shouldUploadStub = sinon.stub(redisModule, "isFileInRedis").returns(new Promise((resolve) => {
            resolve(redisObj);
        }));
        // act
        s3ToAdl = new s3ToAdlDataCopy_1.S3ToAdlDataCopy();
        let shouldUpload = yield s3ToAdl.shouldUploadFile(redisModule, adlModule, expectedElement1);
        // assert
        chai_1.expect(shouldUploadStub.callCount).to.equal(1);
        // expect only one since the second thrown an error
        chai_1.expect(shouldUpload).to.equal(true);
    }));
    it("shouldUploadFile return true and not update redis when redis is empty and file exist on ADL", () => __awaiter(this, void 0, void 0, function* () {
        // given
        process.env["USE_REDIS"] = "true";
        redisModule = new redisModule_1.RedisModule(null);
        const isFileInRedisStub = sinon.stub(redisModule, "isFileInRedis").returns(new Promise((resolve) => {
            resolve(null);
        }));
        const addFileToRedisStub = sinon.stub(redisModule, "addFileToRedis").returns(new Promise((resolve) => {
            resolve();
        }));
        const uploadToAdlStub = sinon.stub(adlModule, "shouldUploadToADL").returns(new Promise((resolve) => {
            resolve(false);
        }));
        // act
        s3ToAdl = new s3ToAdlDataCopy_1.S3ToAdlDataCopy();
        let shouldUpload = yield s3ToAdl.shouldUploadFile(redisModule, adlModule, expectedElement1);
        // assert
        chai_1.expect(isFileInRedisStub.callCount).to.equal(1);
        chai_1.expect(shouldUpload).to.equal(false);
        chai_1.expect(addFileToRedisStub.callCount).to.equal(1);
    }));
    it("shouldUploadFile return true and update redis when redis is empty and file exist on ADL", () => __awaiter(this, void 0, void 0, function* () {
        // given
        process.env["USE_REDIS"] = "true";
        redisModule = new redisModule_1.RedisModule(null);
        const isFileInRedisStub = sinon.stub(redisModule, "isFileInRedis").returns(new Promise((resolve) => {
            resolve(null);
        }));
        const addFileToRedisStub = sinon.stub(redisModule, "addFileToRedis");
        const uploadToAdlStub = sinon.stub(adlModule, "shouldUploadToADL").returns(new Promise((resolve) => {
            resolve(true);
        }));
        // act
        s3ToAdl = new s3ToAdlDataCopy_1.S3ToAdlDataCopy();
        let shouldUpload = yield s3ToAdl.shouldUploadFile(redisModule, adlModule, expectedElement1);
        // assert
        chai_1.expect(isFileInRedisStub.callCount).to.equal(1);
        chai_1.expect(shouldUpload).to.equal(true);
        chai_1.expect(addFileToRedisStub.callCount).to.equal(0);
    }));
});

//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3Rlc3QvczN0b2FkbERhdGFDb3B5VGVzdC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7O0FBQUEsK0JBQStCO0FBRS9CLCtCQUE4QjtBQUU5QixpQkFBZTtBQUdmLCtCQUErQjtBQUMvQixvREFBaUQ7QUFDakQsb0VBQWlFO0FBRWpFLG9EQUE4RDtBQUM5RCw0REFBeUQ7QUFFekQsUUFBUSxDQUFDLGNBQWMsRUFBRTtJQUVyQixJQUFJLE9BQXdCLENBQUM7SUFDN0IsSUFBSSxTQUE4QixDQUFDO0lBQ25DLElBQUksV0FBd0IsQ0FBQztJQUM3QixJQUFJLFdBQXdCLENBQUM7SUFFN0IsTUFBTSxnQkFBZ0IsR0FBRztRQUNyQixJQUFJLEVBQUUsUUFBUTtRQUNkLEdBQUcsRUFBRSxPQUFPO0tBQ2YsQ0FBQztJQUNGLE1BQU0sZ0JBQWdCLEdBQUc7UUFDckIsSUFBSSxFQUFFLFFBQVE7UUFDZCxHQUFHLEVBQUUsT0FBTztLQUNmLENBQUM7SUFFRixVQUFVLENBQUM7UUFDUCxPQUFPLENBQUMsR0FBRyxDQUFDLG1CQUFtQixDQUFDLEdBQUcsS0FBSyxDQUFDO1FBQ3pDLE9BQU8sQ0FBQyxHQUFHLENBQUMsdUJBQXVCLENBQUMsR0FBRyxXQUFXLENBQUM7UUFDbkQsT0FBTyxDQUFDLEdBQUcsQ0FBQyxZQUFZLENBQUMsR0FBRyxRQUFRLENBQUM7UUFDckMsT0FBTyxDQUFDLEdBQUcsQ0FBQyxpQkFBaUIsQ0FBQyxHQUFHLFFBQVEsQ0FBQztRQUMxQyxPQUFPLENBQUMsR0FBRyxDQUFDLGlCQUFpQixDQUFDLEdBQUcsUUFBUSxDQUFDO1FBQzFDLE9BQU8sQ0FBQyxHQUFHLENBQUMsY0FBYyxDQUFDLEdBQUcsUUFBUSxDQUFDO1FBQ3ZDLE9BQU8sQ0FBQyxHQUFHLENBQUMsY0FBYyxDQUFDLEdBQUcsUUFBUSxDQUFDO1FBQ3ZDLE9BQU8sQ0FBQyxHQUFHLENBQUMsd0JBQXdCLENBQUMsR0FBRyxTQUFTLENBQUM7UUFDbEQsT0FBTyxDQUFD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Iiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0ICogYXMgQVdTIGZyb20gXCJhd3Mtc2RrXCI7XHJcbmltcG9ydCAqIGFzIGFkbHNNYW5hZ2VtZW50IGZyb20gXCJhenVyZS1hcm0tZGF0YWxha2Utc3RvcmVcIjtcclxuaW1wb3J0IHsgZXhwZWN0IH0gZnJvbSBcImNoYWlcIjtcclxuaW1wb3J0ICogYXMgZnMgZnJvbSBcImZzXCI7XHJcbmltcG9ydCBcIm1vY2hhXCI7XHJcbmltcG9ydCAqIGFzIEFXU01vY2sgZnJvbSBcIm1vY2stYXdzLXMzXCI7XHJcbmltcG9ydCAqIGFzIG1zcmVzdEF6dXJlIGZyb20gXCJtcy1yZXN0LWF6dXJlXCI7XHJcbmltcG9ydCAqIGFzIHNpbm9uIGZyb20gXCJzaW5vblwiO1xyXG5pbXBvcnQgeyBBd3NTM01vZHVsZSB9IGZyb20gXCIuLi9zcmMvYXdzUzNNb2R1bGVcIjtcclxuaW1wb3J0IHsgQXp1cmVEYXRhTGFrZU1vZHVsZSB9IGZyb20gXCIuLi9zcmMvYXp1cmVEYXRhTGFrZU1vZHVsZVwiO1xyXG5pbXBvcnQgeyBjcmVhdGVEaXJJZk5vdEV4aXN0cywgZGVsZXRlRm9sZGVyIH0gZnJvbSBcIi4uL3NyYy9maWxlc0hlbHBlclwiO1xyXG5pbXBvcnQgeyBSZWRpc01vZHVsZSwgUmVkaXNPYmplY3QgfSBmcm9tIFwiLi4vc3JjL3JlZGlzTW9kdWxlXCI7XHJcbmltcG9ydCB7IFMzVG9BZGxEYXRhQ29weSB9IGZyb20gXCIuLi9zcmMvczNUb0FkbERhdGFDb3B5XCI7XHJcblxyXG5kZXNjcmliZShcImF3cyBzMyB0ZXN0c1wiLCAoKSA9PiB7XHJcblxyXG4gICAgbGV0IHMzVG9BZGw6IFMzVG9BZGxEYXRhQ29weTtcclxuICAgIGxldCBhZGxNb2R1bGU6IEF6dXJlRGF0YUxha2VNb2R1bGU7XHJcbiAgICBsZXQgYXdzUzNNb2R1bGU6IEF3c1MzTW9kdWxlO1xyXG4gICAgbGV0IHJlZGlzTW9kdWxlOiBSZWRpc01vZHVsZTtcclxuXHJcbiAgICBjb25zdCBleHBlY3RlZEVsZW1lbnQxID0ge1xyXG4gICAgICAgIEVUYWc6IFwiMTIzNDU2XCIsXHJcbiAgICAgICAgS2V5OiBcImZpbGUxXCIsXHJcbiAgICB9O1xyXG4gICAgY29uc3QgZXhwZWN0ZWRFbGVtZW50MiA9IHtcclxuICAgICAgICBFVGFnOiBcIjEyMzQ1N1wiLFxyXG4gICAgICAgIEtleTogXCJmaWxlMlwiLFxyXG4gICAgfTtcclxuXHJcbiAgICBiZWZvcmVFYWNoKGZ1bmN0aW9uICgpIHtcclxuICAgICAgICBwcm9jZXNzLmVudltcIkFXU19BQ0NFU1NfS0VZX0lEXCJdID0gXCJrZXlcIjtcclxuICAgICAgICBwcm9jZXNzLmVudltcIkFXU19TRUNSRVRfQUNDRVNTX0tFWVwiXSA9IFwic2VjcmV0a2V5XCI7XHJcbiAgICAgICAgcHJvY2Vzcy5lbnZbXCJBV1NfUkVHSU9OXCJdID0gXCJyZWdpb25cIjtcclxuICAgICAgICBwcm9jZXNzLmVudltcIkFXU19CVUNLRVRfTkFNRVwiXSA9IFwiYnVja2V0XCI7XHJcbiAgICAgICAgcHJvY2Vzcy5lbnZbXCJBWlVSRV9DTElFTlRfSURcIl0gPSBcImNsaWVudFwiO1xyXG4gICAgICAgIHByb2Nlc3MuZW52W1wiQVpVUkVfRE9NQUlOXCJdID0gXCJkb21haW5cIjtcclxuICAgICAgICBwcm9jZXNzLmVudltcIkFaVVJFX1NFQ1JFVFwiXSA9IFwic2VjcmV0XCI7XHJcbiAgICAgICAgcHJvY2Vzcy5lbnZbXCJBWlVSRV9BRExfQUNDT1VOVF9OQU1FXCJdID0gXCJhY2NvdW50XCI7XHJcbiAgICAgICAgcHJvY2Vzcy5lbnZbXCJURU1QX0ZPTERFUlwiXSA9IFwiLi90ZW1wRm9sZGVyXCI7XHJcbiAgICAgICAgcHJvY2Vzcy5lbnZbXCJVU0VfUkVESVNcIl0gPSBcImZhbHNlXCI7XHJcblxyXG4gICAgICAgIGNvbnN0IGJ1Y2tldE5hbWUgPSBcImJ1Y2tldFwiO1xyXG4gICAgICAgIGNvbnN0IHRlbXBGb2xkZXIgPSBcInRlbXBGb2xkZXJcIjtcclxuICAgICAgICBhd3NTM01vZHVsZSA9IG5ldyBBd3NTM01vZHVsZShidWNrZXROYW1lLCB0ZW1wRm9sZGVyLCBuZXcgQVdTLlMzKCkpO1xyXG4gICAgICAgIGFkbE1vZHVsZSA9IG5ldyBBenVyZURhdGFMYWtlTW9kdWxlKFwiYWNjb3VudE5hbWVcIiwgXCJmb2xkZXJOYW1lXCIsIG51bGwpO1xyXG4gICAgfSk7XHJcblxyXG4gICAgaXQoXCJXaGVuIHJlcXVpcmVkIGVudmlyb25tZW50IHZhcmlhYmxlcyBhcmUgbWlzc2luZyBleGNlcHRpb24gaXMgdGhyb3duXCIsICgpID0+IHtcclxuICAgICAgICAvLyBnaXZlblxyXG4gICAgICAgIGRlbGV0ZSBwcm9jZXNzLmVudltcIkFaVVJFX0FETF9BQ0NPVU5UX05BTUVcIl07XHJcblxyXG4gICAgICAgIC8vIGFjdFxyXG4gICAgICAgIHRyeSB7XHJcbiAgICAgICAgICAgIHMzVG9BZGwgPSBuZXcgUzNUb0FkbERhdGFDb3B5KCk7XHJcbiAgICAgICAgfSBjYXRjaCAoZXgpIHtcclxuICAgICAgICAgICAgLy8gYXNzZXJ0XHJcbiAgICAgICAgICAgIGV4cGVjdChleC5tZXNzYWdlKS50by5lcXVhbChcIkVudmlyb25tZW50IFZhcmlhYmxlIEFaVVJFX0FETF9BQ0NPVU5UX05BTUUgaXMgbm90IGRlZmluZWRcIik7XHJcbiAgICAgICAgfVxyXG4gICAgfSk7XHJcblxyXG4gICAgaXQoXCJXaGVuIFVTRV9SRURJUyBpcyBzZXQgdG8gb3RoZXIgdmFyaWFibGUgdGhlbiB0cnVlL2ZhbHNlIGV4Y2VwdGlvbiBpcyB0aHJvd25cIiwgKCkgPT4ge1xyXG4gICAgICAgIC8vIGdpdmVuXHJcbiAgICAgICAgcHJvY2Vzcy5lbnZbXCJVU0VfUkVESVNcIl0gPSBcInNvbWUgdmFsdWVcIjtcclxuXHJcbiAgICAgICAgLy8gYWN0XHJcbiAgICAgICAgdHJ5IHtcclxuICAgICAgICAgICAgczNUb0FkbCA9IG5ldyBTM1RvQWRsRGF0YUNvcHkoKTtcclxuICAgICAgICB9IGNhdGNoIChleCkge1xyXG4gICAgICAgICAgICAvLyBhc3NlcnRcclxuICAgICAgICAgICAgZXhwZWN0KGV4Lm1lc3NhZ2UpLnRvLmVxdWFsKFwiRW52aXJvbm1lbnQgVmFyaWFibGUgVVNFX1JFRElTIHNob3VsZCBjb250YWluIGJvb2xlYW4gdmFsdWVcIik7XHJcbiAgICAgICAgfVxyXG4gICAgfSk7XHJcblxyXG4gICAgaXQoXCJiYXRjaEl0ZXJhdGlvbk92ZXJTM0l0ZW1zIGRvZXNuJ3QgdXBsb2FkcyBmaWxlIHdoZW4gaXQncyBhbHJlYWR5IGV4aXN0c1wiLCBhc3luYyAoKSA9PiB7XHJcbiAgICAgICAgLy8gZ2l2ZW5cclxuICAgICAgICBzaW5vbi5zdHViKGF3c1MzTW9kdWxlLCBcImxpc3RBbGxPYmplY3RzXCIpLnJldHVybnMoe1xyXG4gICAgICAgICAgICBDb250ZW50czogW2V4cGVjdGVkRWxlbWVudDEsIGV4cGVjdGVkRWxlbWVudDJdLFxyXG4gICAgICAgIH0pO1xyXG5cclxuICAgICAgICBjb25zdCB1cGxvYWRUb0FkbFN0dWIgPSBzaW5vbi5zdHViKGFkbE1vZHVsZSwgXCJzaG91bGRVcGxvYWRUb0FETFwiKS5yZXR1cm5zKG5ldyBQcm9taXNlPGJvb2xlYW4+KChyZXNvbHZlKSA9PiB7XHJcbiAgICAgICAgICAgIHJlc29sdmUoZmFsc2UpO1xyXG4gICAgICAgIH0pKTtcclxuXHJcbiAgICAgICAgY29uc3QgYXdzU3B5ID0gc2lub24uc3B5KGF3c1MzTW9kdWxlLCBcImRvd25sb2FkRmlsZUZyb21TM1wiKTtcclxuXHJcbiAgICAgICAgLy8gYWN0XHJcbiAgICAgICAgczNUb0FkbCA9IG5ldyBTM1RvQWRsRGF0YUNvcHkoKTtcclxuICAgICAgICBhd2FpdCBzM1RvQWRsLmJhdGNoSXRlcmF0aW9uT3ZlclMzSXRlbXMoYXdzUzNNb2R1bGUsIGFkbE1vZHVsZSwgbnVsbCk7XHJcblxyXG4gICAgICAgIC8vIGFzc2VydFxyXG4gICAgICAgIGV4cGVjdChhd3NTcHkuY2FsbENvdW50KS50by5lcXVhbCgwKTtcclxuICAgICAgICBleHBlY3QodXBsb2FkVG9BZGxTdHViLmNhbGxDb3VudCkudG8uZXF1YWwoMik7XHJcbiAgICB9KTtcclxuXHJcbiAgICBpdChcImJhdGNoSXRlcmF0aW9uT3ZlclMzSXRlbXMgdXBsb2FkcyB0aGUgbWlzc2luZyBmaWxlIGluIEFETFwiLCBhc3luYyAoKSA9PiB7XHJcbiAgICAgICAgLy8gZ2l2ZW5cclxuICAgICAgICBzaW5vbi5zdHViKGF3c1MzTW9kdWxlLCBcImxpc3RBbGxPYmplY3RzXCIpLnJldHVybnMoe1xyXG4gICAgICAgICAgICBDb250ZW50czogW2V4cGVjdGVkRWxlbWVudDEsIGV4cGVjdGVkRWxlbWVudDJdLFxyXG4gICAgICAgIH0pO1xyXG4gICAgICAgIGxldCBkb3dubG9hZFN0dWIgPSBzaW5vbi5zdHViKGF3c1MzTW9kdWxlLCBcImRvd25sb2FkRmlsZUZyb21TM1wiKS5yZXR1cm5zKG5ldyBQcm9taXNlKChyZXNvbHZlKSA9PiByZXNvbHZlKCkpKTtcclxuICAgICAgICBzaW5vbi5zdHViKGFkbE1vZHVsZSwgXCJ1cGxvYWRGaWxlVG9BenVyZURhdGFMYWtlXCIpLnJldHVybnMobmV3IFByb21pc2UoKHJlc29sdmUpID0+IHJlc29sdmUoKSkpO1xyXG5cclxuICAgICAgICBjb25zdCB1cGxvYWRTdHViID0gc2lub24uc3R1YihhZGxNb2R1bGUsIFwic2hvdWxkVXBsb2FkVG9BRExcIik7XHJcbiAgICAgICAgdXBsb2FkU3R1Yi53aXRoQXJncyhleHBlY3RlZEVsZW1lbnQxKS5yZXR1cm5zKG5ldyBQcm9taXNlPGJvb2xlYW4+KChyZXNvbHZlKSA9PiB7XHJcbiAgICAgICAgICAgIHJlc29sdmUoZmFsc2UpO1xyXG4gICAgICAgIH0pKTtcclxuICAgICAgICB1cGxvYWRTdHViLndpdGhBcmdzKGV4cGVjdGVkRWxlbWVudDIpLnJldHVybnMobmV3IFByb21pc2U8Ym9vbGVhbj4oKHJlc29sdmUpID0+IHtcclxuICAgICAgICAgICAgcmVzb2x2ZSh0cnVlKTtcclxuICAgICAgICB9KSk7XHJcblxyXG4gICAgICAgIC8vIGFjdFxyXG4gICAgICAgIHMzVG9BZGwgPSBuZXcgUzNUb0FkbERhdGFDb3B5KCk7XHJcbiAgICAgICAgYXdhaXQgczNUb0FkbC5iYXRjaEl0ZXJhdGlvbk92ZXJTM0l0ZW1zKGF3c1MzTW9kdWxlLCBhZGxNb2R1bGUsIG51bGwpO1xyXG5cclxuICAgICAgICAvLyBhc3NlcnRcclxuICAgICAgICBleHBlY3QoZG93bmxvYWRTdHViLmNhbGxDb3VudCkudG8uZXF1YWwoMSk7XHJcbiAgICAgICAgZXhwZWN0KHVwbG9hZFN0dWIuY2FsbENvdW50KS50by5lcXVhbCgyKTtcclxuICAgIH0pO1xyXG5cclxuICAgIGl0KFwiYmF0Y2hJdGVyYXRpb25PdmVyUzNJdGVtcyB3aGVuIGVycm9yIGlzIHRocm93biB3aGlsZSB1cGxvYWRpbmcgZmlsZSBpdGVyYXRpb24gY29udGludWVzIGFzIGV4cGVjdGVkXCIsIGFzeW5jICgpID0+IHtcclxuICAgICAgICAvLyBnaXZlblxyXG4gICAgICAgIHNpbm9uLnN0dWIoYXdzUzNNb2R1bGUsIFwibGlzdEFsbE9iamVjdHNcIikucmV0dXJucyh7XHJcbiAgICAgICAgICAgIENvbnRlbnRzOiBbZXhwZWN0ZWRFbGVtZW50MSwgZXhwZWN0ZWRFbGVtZW50Ml0sXHJcbiAgICAgICAgfSk7XHJcblxyXG4gICAgICAgIGxldCBkb3dubG9hZFN0dWIgPSBzaW5vbi5zdHViKGF3c1MzTW9kdWxlLCBcImRvd25sb2FkRmlsZUZyb21TM1wiKS5yZXR1cm5zKG5ldyBQcm9taXNlKChyZXNvbHZlKSA9PiByZXNvbHZlKCkpKTtcclxuICAgICAgICBsZXQgdXBsb2FkU3R1YiA9IHNpbm9uLnN0dWIoYWRsTW9kdWxlLCBcInVwbG9hZEZpbGVUb0F6dXJlRGF0YUxha2VcIik7XHJcbiAgICAgICAgdXBsb2FkU3R1Yi53aXRoQXJncyhleHBlY3RlZEVsZW1lbnQxLktleSkudGhyb3dzKG5ldyBFcnJvcigpKTtcclxuICAgICAgICB1cGxvYWRTdHViLndpdGhBcmdzKGV4cGVjdGVkRWxlbWVudDIuS2V5KS5yZXR1cm5zKG5ldyBQcm9taXNlKChyZXNvbHZlKSA9PiByZXNvbHZlKCkpKTtcclxuXHJcbiAgICAgICAgY29uc3Qgc2hvdWxkVXBsb2FkU3R1YiA9IHNpbm9uLnN0dWIoYWRsTW9kdWxlLCBcInNob3VsZFVwbG9hZFRvQURMXCIpLnJldHVybnMobmV3IFByb21pc2U8Ym9vbGVhbj4oKHJlc29sdmUpID0+IHtcclxuICAgICAgICAgICAgcmVzb2x2ZSh0cnVlKTtcclxuICAgICAgICB9KSk7XHJcblxyXG4gICAgICAgIC8vIGFjdFxyXG4gICAgICAgIHMzVG9BZGwgPSBuZXcgUzNUb0FkbERhdGFDb3B5KCk7XHJcbiAgICAgICAgYXdhaXQgczNUb0FkbC5iYXRjaEl0ZXJhdGlvbk92ZXJTM0l0ZW1zKGF3c1MzTW9kdWxlLCBhZGxNb2R1bGUsIG51bGwpO1xyXG5cclxuICAgICAgICAvLyBhc3NlcnRcclxuICAgICAgICBleHBlY3QoZG93bmxvYWRTdHViLmNhbGxDb3VudCkudG8uZXF1YWwoMik7XHJcbiAgICAgICAgZXhwZWN0KHNob3VsZFVwbG9hZFN0dWIuY2FsbENvdW50KS50by5lcXVhbCgyKTtcclxuICAgICAgICAvLyBleHBlY3Qgb25seSBvbmUgc2luY2UgdGhlIHNlY29uZCB0aHJvd24gYW4gZXJyb3JcclxuICAgICAgICBleHBlY3QoczNUb0FkbC5jb3B5UHJvcGVydGllcy51cGxvYWRlZENvdW50KS50by5lcXVhbCgxKTtcclxuICAgIH0pO1xyXG5cclxuICAgIGl0KFwic2hvdWxkVXBsb2FkRmlsZSByZXR1cm4gZmFsc2Ugd2hlbiB1c2luZyByZWRpcyBhbmQgZmlsZSBleGlzdCBvbiBBRExcIiwgYXN5bmMgKCkgPT4ge1xyXG4gICAgICAgIC8vIGdpdmVuXHJcbiAgICAgICAgcHJvY2Vzcy5lbnZbXCJVU0VfUkVESVNcIl0gPSBcInRydWVcIjtcclxuICAgICAgICBjb25zdCByZWRpc09iaiA9IG5ldyBSZWRpc09iamVjdCgpO1xyXG4gICAgICAgIHJlZGlzT2JqLkVUYWcgPSBleHBlY3RlZEVsZW1lbnQxLkVUYWc7XHJcbiAgICAgICAgcmVkaXNNb2R1bGUgPSBuZXcgUmVkaXNNb2R1bGUobnVsbCk7XHJcbiAgICAgICAgY29uc3Qgc2hvdWxkVXBsb2FkU3R1YiA9IHNpbm9uLnN0dWIocmVkaXNNb2R1bGUsIFwiaXNGaWxlSW5SZWRpc1wiKS5yZXR1cm5zKG5ldyBQcm9taXNlPFJlZGlzT2JqZWN0PigocmVzb2x2ZSkgPT4ge1xyXG4gICAgICAgICAgICByZXNvbHZlKHJlZGlzT2JqKTtcclxuICAgICAgICB9KSk7XHJcblxyXG4gICAgICAgIC8vIGFjdFxyXG4gICAgICAgIHMzVG9BZGwgPSBuZXcgUzNUb0FkbERhdGFDb3B5KCk7XHJcbiAgICAgICAgbGV0IHNob3VsZFVwbG9hZCA9IGF3YWl0IHMzVG9BZGwuc2hvdWxkVXBsb2FkRmlsZShyZWRpc01vZHVsZSwgYWRsTW9kdWxlLCBleHBlY3RlZEVsZW1lbnQxKTtcclxuXHJcbiAgICAgICAgLy8gYXNzZXJ0XHJcbiAgICAgICAgZXhwZWN0KHNob3VsZFVwbG9hZFN0dWIuY2FsbENvdW50KS50by5lcXVhbCgxKTtcclxuICAgICAgICAvLyBleHBlY3Qgb25seSBvbmUgc2luY2UgdGhlIHNlY29uZCB0aHJvd24gYW4gZXJyb3JcclxuICAgICAgICBleHBlY3Qoc2hvdWxkVXBsb2FkKS50by5lcXVhbChmYWxzZSk7XHJcbiAgICB9KTtcclxuXHJcbiAgICBpdChcInNob3VsZFVwbG9hZEZpbGUgcmV0dXJuIHRydWUgd2hlbiB1c2luZyByZWRpcyBhbmQgZmlsZSBpcyBtaXNzaW5nIGZyb20gQURMXCIsIGFzeW5jICgpID0+IHtcclxuICAgICAgICAvLyBnaXZlblxyXG4gICAgICAgIHByb2Nlc3MuZW52W1wiVVNFX1JFRElTXCJdID0gXCJ0cnVlXCI7XHJcbiAgICAgICAgY29uc3QgcmVkaXNPYmogPSBuZXcgUmVkaXNPYmplY3QoKTtcclxuICAgICAgICByZWRpc09iai5FVGFnID0gXCI2NTQzMzIxXCI7XHJcbiAgICAgICAgcmVkaXNNb2R1bGUgPSBuZXcgUmVkaXNNb2R1bGUobnVsbCk7XHJcbiAgICAgICAgY29uc3Qgc2hvdWxkVXBsb2FkU3R1YiA9IHNpbm9uLnN0dWIocmVkaXNNb2R1bGUsIFwiaXNGaWxlSW5SZWRpc1wiKS5yZXR1cm5zKG5ldyBQcm9taXNlPFJlZGlzT2JqZWN0PigocmVzb2x2ZSkgPT4ge1xyXG4gICAgICAgICAgICByZXNvbHZlKHJlZGlzT2JqKTtcclxuICAgICAgICB9KSk7XHJcblxyXG4gICAgICAgIC8vIGFjdFxyXG4gICAgICAgIHMzVG9BZGwgPSBuZXcgUzNUb0FkbERhdGFDb3B5KCk7XHJcbiAgICAgICAgbGV0IHNob3VsZFVwbG9hZCA9IGF3YWl0IHMzVG9BZGwuc2hvdWxkVXBsb2FkRmlsZShyZWRpc01vZHVsZSwgYWRsTW9kdWxlLCBleHBlY3RlZEVsZW1lbnQxKTtcclxuXHJcbiAgICAgICAgLy8gYXNzZXJ0XHJcbiAgICAgICAgZXhwZWN0KHNob3VsZFVwbG9hZFN0dWIuY2FsbENvdW50KS50by5lcXVhbCgxKTtcclxuICAgICAgICAvLyBleHBlY3Qgb25seSBvbmUgc2luY2UgdGhlIHNlY29uZCB0aHJvd24gYW4gZXJyb3JcclxuICAgICAgICBleHBlY3Qoc2hvdWxkVXBsb2FkKS50by5lcXVhbCh0cnVlKTtcclxuICAgIH0pO1xyXG5cclxuICAgIGl0KFwic2hvdWxkVXBsb2FkRmlsZSByZXR1cm4gdHJ1ZSBhbmQgbm90IHVwZGF0ZSByZWRpcyB3aGVuIHJlZGlzIGlzIGVtcHR5IGFuZCBmaWxlIGV4aXN0IG9uIEFETFwiLCBhc3luYyAoKSA9PiB7XHJcbiAgICAgICAgLy8gZ2l2ZW5cclxuICAgICAgICBwcm9jZXNzLmVudltcIlVTRV9SRURJU1wiXSA9IFwidHJ1ZVwiO1xyXG4gICAgICAgIHJlZGlzTW9kdWxlID0gbmV3IFJlZGlzTW9kdWxlKG51bGwpO1xyXG4gICAgICAgIGNvbnN0IGlzRmlsZUluUmVkaXNTdHViID0gc2lub24uc3R1YihyZWRpc01vZHVsZSwgXCJpc0ZpbGVJblJlZGlzXCIpLnJldHVybnMobmV3IFByb21pc2U8UmVkaXNPYmplY3Q+KChyZXNvbHZlKSA9PiB7XHJcbiAgICAgICAgICAgIHJlc29sdmUobnVsbCk7XHJcbiAgICAgICAgfSkpO1xyXG5cclxuICAgICAgICBjb25zdCBhZGRGaWxlVG9SZWRpc1N0dWIgPSBzaW5vbi5zdHViKHJlZGlzTW9kdWxlLCBcImFkZEZpbGVUb1JlZGlzXCIpLnJldHVybnMobmV3IFByb21pc2U8UmVkaXNPYmplY3Q+KChyZXNvbHZlKSA9PiB7XHJcbiAgICAgICAgICAgIHJlc29sdmUoKTtcclxuICAgICAgICB9KSk7XHJcbiAgICAgICAgY29uc3QgdXBsb2FkVG9BZGxTdHViID0gc2lub24uc3R1YihhZGxNb2R1bGUsIFwic2hvdWxkVXBsb2FkVG9BRExcIikucmV0dXJucyhuZXcgUHJvbWlzZTxib29sZWFuPigocmVzb2x2ZSkgPT4ge1xyXG4gICAgICAgICAgICByZXNvbHZlKGZhbHNlKTtcclxuICAgICAgICB9KSk7XHJcblxyXG4gICAgICAgIC8vIGFjdFxyXG4gICAgICAgIHMzVG9BZGwgPSBuZXcgUzNUb0FkbERhdGFDb3B5KCk7XHJcbiAgICAgICAgbGV0IHNob3VsZFVwbG9hZCA9IGF3YWl0IHMzVG9BZGwuc2hvdWxkVXBsb2FkRmlsZShyZWRpc01vZHVsZSwgYWRsTW9kdWxlLCBleHBlY3RlZEVsZW1lbnQxKTtcclxuXHJcbiAgICAgICAgLy8gYXNzZXJ0XHJcbiAgICAgICAgZXhwZWN0KGlzRmlsZUluUmVkaXNTdHViLmNhbGxDb3VudCkudG8uZXF1YWwoMSk7XHJcbiAgICAgICAgZXhwZWN0KHNob3VsZFVwbG9hZCkudG8uZXF1YWwoZmFsc2UpO1xyXG4gICAgICAgIGV4cGVjdChhZGRGaWxlVG9SZWRpc1N0dWIuY2FsbENvdW50KS50by5lcXVhbCgxKTtcclxuICAgIH0pO1xyXG5cclxuICAgIGl0KFwic2hvdWxkVXBsb2FkRmlsZSByZXR1cm4gdHJ1ZSBhbmQgdXBkYXRlIHJlZGlzIHdoZW4gcmVkaXMgaXMgZW1wdHkgYW5kIGZpbGUgZXhpc3Qgb24gQURMXCIsIGFzeW5jICgpID0+IHtcclxuICAgICAgICAvLyBnaXZlblxyXG4gICAgICAgIHByb2Nlc3MuZW52W1wiVVNFX1JFRElTXCJdID0gXCJ0cnVlXCI7XHJcbiAgICAgICAgcmVkaXNNb2R1bGUgPSBuZXcgUmVkaXNNb2R1bGUobnVsbCk7XHJcbiAgICAgICAgY29uc3QgaXNGaWxlSW5SZWRpc1N0dWIgPSBzaW5vbi5zdHViKHJlZGlzTW9kdWxlLCBcImlzRmlsZUluUmVkaXNcIikucmV0dXJucyhuZXcgUHJvbWlzZTxSZWRpc09iamVjdD4oKHJlc29sdmUpID0+IHtcclxuICAgICAgICAgICAgcmVzb2x2ZShudWxsKTtcclxuICAgICAgICB9KSk7XHJcblxyXG4gICAgICAgIGNvbnN0IGFkZEZpbGVUb1JlZGlzU3R1YiA9IHNpbm9uLnN0dWIocmVkaXNNb2R1bGUsIFwiYWRkRmlsZVRvUmVkaXNcIik7XHJcbiAgICAgICAgY29uc3QgdXBsb2FkVG9BZGxTdHViID0gc2lub24uc3R1YihhZGxNb2R1bGUsIFwic2hvdWxkVXBsb2FkVG9BRExcIikucmV0dXJucyhuZXcgUHJvbWlzZTxib29sZWFuPigocmVzb2x2ZSkgPT4ge1xyXG4gICAgICAgICAgICByZXNvbHZlKHRydWUpO1xyXG4gICAgICAgIH0pKTtcclxuXHJcbiAgICAgICAgLy8gYWN0XHJcbiAgICAgICAgczNUb0FkbCA9IG5ldyBTM1RvQWRsRGF0YUNvcHkoKTtcclxuICAgICAgICBsZXQgc2hvdWxkVXBsb2FkID0gYXdhaXQgczNUb0FkbC5zaG91bGRVcGxvYWRGaWxlKHJlZGlzTW9kdWxlLCBhZGxNb2R1bGUsIGV4cGVjdGVkRWxlbWVudDEpO1xyXG5cclxuICAgICAgICAvLyBhc3NlcnRcclxuICAgICAgICBleHBlY3QoaXNGaWxlSW5SZWRpc1N0dWIuY2FsbENvdW50KS50by5lcXVhbCgxKTtcclxuICAgICAgICBleHBlY3Qoc2hvdWxkVXBsb2FkKS50by5lcXVhbCh0cnVlKTtcclxuICAgICAgICBleHBlY3QoYWRkRmlsZVRvUmVkaXNTdHViLmNhbGxDb3VudCkudG8uZXF1YWwoMCk7XHJcbiAgICB9KTtcclxufSk7Il0sInNvdXJjZVJvb3QiOiIuLiJ9
