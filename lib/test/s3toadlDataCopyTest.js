"use strict";
var __awaiter = (this && this.__awaiter) || function (thisArg, _arguments, P, generator) {
    return new (P || (P = Promise))(function (resolve, reject) {
        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }
        function rejected(value) { try { step(generator["throw"](value)); } catch (e) { reject(e); } }
        function step(result) { result.done ? resolve(result.value) : new P(function (resolve) { resolve(result.value); }).then(fulfilled, rejected); }
        step((generator = generator.apply(thisArg, _arguments || [])).next());
    });
};
Object.defineProperty(exports, "__esModule", { value: true });
const AWS = require("aws-sdk");
const chai_1 = require("chai");
require("mocha");
const sinon = require("sinon");
const awsS3Module_1 = require("../src/awsS3Module");
const azureDataLakeModule_1 = require("../src/azureDataLakeModule");
const redisModule_1 = require("../src/redisModule");
const s3ToAdlDataCopy_1 = require("../src/s3ToAdlDataCopy");
describe("aws s3 tests", () => {
    let s3ToAdl;
    let adlModule;
    let awsS3Module;
    let redisModule;
    const expectedElement1 = {
        ETag: "123456",
        Key: "file1",
    };
    const expectedElement2 = {
        ETag: "123457",
        Key: "file2",
    };
    beforeEach(function () {
        process.env["AWS_ACCESS_KEY_ID"] = "key";
        process.env["AWS_SECRET_ACCESS_KEY"] = "secretkey";
        process.env["AWS_REGION"] = "region";
        process.env["AWS_BUCKET_NAME"] = "bucket";
        process.env["AZURE_CLIENT_ID"] = "client";
        process.env["AZURE_DOMAIN"] = "domain";
        process.env["AZURE_SECRET"] = "secret";
        process.env["AZURE_ADL_ACCOUNT_NAME"] = "account";
        process.env["TEMP_FOLDER"] = "./tempFolder";
        process.env["USE_REDIS"] = "false";
        const bucketName = "bucket";
        const tempFolder = "tempFolder";
        awsS3Module = new awsS3Module_1.AwsS3Module(bucketName, tempFolder, new AWS.S3());
        adlModule = new azureDataLakeModule_1.AzureDataLakeModule("accountName", "folderName", null, "bucket");
    });
    it("When required environment variables are missing exception is thrown", () => {
        // given
        delete process.env["AZURE_ADL_ACCOUNT_NAME"];
        // act
        try {
            s3ToAdl = new s3ToAdlDataCopy_1.S3ToAdlDataCopy();
        }
        catch (ex) {
            // assert
            chai_1.expect(ex.message).to.equal("Environment Variable AZURE_ADL_ACCOUNT_NAME is not defined");
        }
    });
    it("When USE_REDIS is set to other variable then true/false exception is thrown", () => {
        // given
        process.env["USE_REDIS"] = "some value";
        // act
        try {
            s3ToAdl = new s3ToAdlDataCopy_1.S3ToAdlDataCopy();
        }
        catch (ex) {
            // assert
            chai_1.expect(ex.message).to.equal("Environment Variable USE_REDIS should contain boolean value");
        }
    });
    it("batchIterationOverS3Items doesn't uploads file when it's already exists", () => __awaiter(this, void 0, void 0, function* () {
        // given
        sinon.stub(awsS3Module, "listAllObjects").returns({
            Contents: [expectedElement1, expectedElement2],
        });
        const uploadToAdlStub = sinon.stub(adlModule, "shouldUploadToADL").returns(new Promise((resolve) => {
            resolve(false);
        }));
        const awsSpy = sinon.spy(awsS3Module, "downloadFileFromS3");
        // act
        s3ToAdl = new s3ToAdlDataCopy_1.S3ToAdlDataCopy();
        yield s3ToAdl.batchIterationOverS3Items(awsS3Module, adlModule, null);
        // assert
        chai_1.expect(awsSpy.callCount).to.equal(0);
        chai_1.expect(uploadToAdlStub.callCount).to.equal(2);
    }));
    it("batchIterationOverS3Items uploads the missing file in ADL", () => __awaiter(this, void 0, void 0, function* () {
        // given
        sinon.stub(awsS3Module, "listAllObjects").returns({
            Contents: [expectedElement1, expectedElement2],
        });
        let downloadStub = sinon.stub(awsS3Module, "downloadFileFromS3").returns(new Promise((resolve) => resolve()));
        sinon.stub(adlModule, "uploadFileToAzureDataLake").returns(new Promise((resolve) => resolve()));
        const uploadStub = sinon.stub(adlModule, "shouldUploadToADL");
        uploadStub.withArgs(expectedElement1).returns(new Promise((resolve) => {
            resolve(false);
        }));
        uploadStub.withArgs(expectedElement2).returns(new Promise((resolve) => {
            resolve(true);
        }));
        // act
        s3ToAdl = new s3ToAdlDataCopy_1.S3ToAdlDataCopy();
        yield s3ToAdl.batchIterationOverS3Items(awsS3Module, adlModule, null);
        // assert
        chai_1.expect(downloadStub.callCount).to.equal(1);
        chai_1.expect(uploadStub.callCount).to.equal(2);
    }));
    it("batchIterationOverS3Items when error is thrown while uploading file iteration continues as expected", () => __awaiter(this, void 0, void 0, function* () {
        // given
        sinon.stub(awsS3Module, "listAllObjects").returns({
            Contents: [expectedElement1, expectedElement2],
        });
        let downloadStub = sinon.stub(awsS3Module, "downloadFileFromS3").returns(new Promise((resolve) => resolve()));
        let uploadStub = sinon.stub(adlModule, "uploadFileToAzureDataLake");
        uploadStub.withArgs(expectedElement1.Key).throws(new Error());
        uploadStub.withArgs(expectedElement2.Key).returns(new Promise((resolve) => resolve()));
        const shouldUploadStub = sinon.stub(adlModule, "shouldUploadToADL").returns(new Promise((resolve) => {
            resolve(true);
        }));
        // act
        s3ToAdl = new s3ToAdlDataCopy_1.S3ToAdlDataCopy();
        yield s3ToAdl.batchIterationOverS3Items(awsS3Module, adlModule, null);
        // assert
        chai_1.expect(downloadStub.callCount).to.equal(2);
        chai_1.expect(shouldUploadStub.callCount).to.equal(2);
        // expect only one since the second thrown an error
        chai_1.expect(s3ToAdl.copyProperties.uploadedCount).to.equal(1);
    }));
    it("shouldUploadFile return false when using redis and file exist on ADL", () => __awaiter(this, void 0, void 0, function* () {
        // given
        process.env["USE_REDIS"] = "true";
        const redisObj = new redisModule_1.RedisObject();
        redisObj.ETag = expectedElement1.ETag;
        redisModule = new redisModule_1.RedisModule(null);
        const shouldUploadStub = sinon.stub(redisModule, "isFileInRedis").returns(new Promise((resolve) => {
            resolve(redisObj);
        }));
        // act
        s3ToAdl = new s3ToAdlDataCopy_1.S3ToAdlDataCopy();
        let shouldUpload = yield s3ToAdl.shouldUploadFile(redisModule, adlModule, expectedElement1);
        // assert
        chai_1.expect(shouldUploadStub.callCount).to.equal(1);
        // expect only one since the second thrown an error
        chai_1.expect(shouldUpload).to.equal(false);
    }));
    it("shouldUploadFile return true when using redis and file is missing from ADL", () => __awaiter(this, void 0, void 0, function* () {
        // given
        process.env["USE_REDIS"] = "true";
        const redisObj = new redisModule_1.RedisObject();
        redisObj.ETag = "6543321";
        redisModule = new redisModule_1.RedisModule(null);
        const shouldUploadStub = sinon.stub(redisModule, "isFileInRedis").returns(new Promise((resolve) => {
            resolve(redisObj);
        }));
        // act
        s3ToAdl = new s3ToAdlDataCopy_1.S3ToAdlDataCopy();
        let shouldUpload = yield s3ToAdl.shouldUploadFile(redisModule, adlModule, expectedElement1);
        // assert
        chai_1.expect(shouldUploadStub.callCount).to.equal(1);
        // expect only one since the second thrown an error
        chai_1.expect(shouldUpload).to.equal(true);
    }));
    it("shouldUploadFile return true and not update redis when redis is empty and file exist on ADL", () => __awaiter(this, void 0, void 0, function* () {
        // given
        process.env["USE_REDIS"] = "true";
        redisModule = new redisModule_1.RedisModule(null);
        const isFileInRedisStub = sinon.stub(redisModule, "isFileInRedis").returns(new Promise((resolve) => {
            resolve(null);
        }));
        const addFileToRedisStub = sinon.stub(redisModule, "addFileToRedis").returns(new Promise((resolve) => {
            resolve();
        }));
        const uploadToAdlStub = sinon.stub(adlModule, "shouldUploadToADL").returns(new Promise((resolve) => {
            resolve(false);
        }));
        // act
        s3ToAdl = new s3ToAdlDataCopy_1.S3ToAdlDataCopy();
        let shouldUpload = yield s3ToAdl.shouldUploadFile(redisModule, adlModule, expectedElement1);
        // assert
        chai_1.expect(isFileInRedisStub.callCount).to.equal(1);
        chai_1.expect(shouldUpload).to.equal(false);
        chai_1.expect(addFileToRedisStub.callCount).to.equal(1);
    }));
    it("shouldUploadFile return true and update redis when redis is empty and file exist on ADL", () => __awaiter(this, void 0, void 0, function* () {
        // given
        process.env["USE_REDIS"] = "true";
        redisModule = new redisModule_1.RedisModule(null);
        const isFileInRedisStub = sinon.stub(redisModule, "isFileInRedis").returns(new Promise((resolve) => {
            resolve(null);
        }));
        const addFileToRedisStub = sinon.stub(redisModule, "addFileToRedis");
        const uploadToAdlStub = sinon.stub(adlModule, "shouldUploadToADL").returns(new Promise((resolve) => {
            resolve(true);
        }));
        // act
        s3ToAdl = new s3ToAdlDataCopy_1.S3ToAdlDataCopy();
        let shouldUpload = yield s3ToAdl.shouldUploadFile(redisModule, adlModule, expectedElement1);
        // assert
        chai_1.expect(isFileInRedisStub.callCount).to.equal(1);
        chai_1.expect(shouldUpload).to.equal(true);
        chai_1.expect(addFileToRedisStub.callCount).to.equal(0);
    }));
});

//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3Rlc3QvczN0b2FkbERhdGFDb3B5VGVzdC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7O0FBQUEsK0JBQStCO0FBRS9CLCtCQUE4QjtBQUU5QixpQkFBZTtBQUdmLCtCQUErQjtBQUMvQixvREFBaUQ7QUFDakQsb0VBQWlFO0FBRWpFLG9EQUE4RDtBQUM5RCw0REFBeUQ7QUFFekQsUUFBUSxDQUFDLGNBQWMsRUFBRTtJQUVyQixJQUFJLE9BQXdCLENBQUM7SUFDN0IsSUFBSSxTQUE4QixDQUFDO0lBQ25DLElBQUksV0FBd0IsQ0FBQztJQUM3QixJQUFJLFdBQXdCLENBQUM7SUFFN0IsTUFBTSxnQkFBZ0IsR0FBRztRQUNyQixJQUFJLEVBQUUsUUFBUTtRQUNkLEdBQUcsRUFBRSxPQUFPO0tBQ2YsQ0FBQztJQUNGLE1BQU0sZ0JBQWdCLEdBQUc7UUFDckIsSUFBSSxFQUFFLFFBQVE7UUFDZCxHQUFHLEVBQUUsT0FBTztLQUNmLENBQUM7SUFFRixVQUFVLENBQUM7UUFDUCxPQUFPLENBQUMsR0FBRyxDQUFDLG1CQUFtQixDQUFDLEdBQUcsS0FBSyxDQUFDO1FBQ3pDLE9BQU8sQ0FBQyxHQUFHLENBQUMsdUJBQXVCLENBQUMsR0FBRyxXQUFXLENBQUM7UUFDbkQsT0FBTyxDQUFDLEdBQUcsQ0FBQyxZQUFZLENBQUMsR0FBRyxRQUFRLENBQUM7UUFDckMsT0FBTyxDQUFDLEdBQUcsQ0FBQyxpQkFBaUIsQ0FBQyxHQUFHLFFBQVEsQ0FBQztRQUMxQyxPQUFPLENBQUMsR0FBRyxDQUFDLGlCQUFpQixDQUFDLEdBQUcsUUFBUSxDQUFDO1FBQzFDLE9BQU8sQ0FBQyxHQUFHLENBQUMsY0FBYyxDQUFDLEdBQUcsUUFBUSxDQUFDO1FBQ3ZDLE9BQU8sQ0FBQyxHQUFHLENBQUMsY0FBYyxDQUFDLEdBQUcsUUFBUSxDQUFDO1FBQ3ZDLE9BQU8sQ0FBQyxHQUFHLENBQUMsd0JBQXdCLENBQUMsR0FBRyxTQUFTLENBQUM7UUFDbEQsT0FBTyxDQUFD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b3B5VGVzdC5qcyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCAqIGFzIEFXUyBmcm9tIFwiYXdzLXNka1wiO1xyXG5pbXBvcnQgKiBhcyBhZGxzTWFuYWdlbWVudCBmcm9tIFwiYXp1cmUtYXJtLWRhdGFsYWtlLXN0b3JlXCI7XHJcbmltcG9ydCB7IGV4cGVjdCB9IGZyb20gXCJjaGFpXCI7XHJcbmltcG9ydCAqIGFzIGZzIGZyb20gXCJmc1wiO1xyXG5pbXBvcnQgXCJtb2NoYVwiO1xyXG5pbXBvcnQgKiBhcyBBV1NNb2NrIGZyb20gXCJtb2NrLWF3cy1zM1wiO1xyXG5pbXBvcnQgKiBhcyBtc3Jlc3RBenVyZSBmcm9tIFwibXMtcmVzdC1henVyZVwiO1xyXG5pbXBvcnQgKiBhcyBzaW5vbiBmcm9tIFwic2lub25cIjtcclxuaW1wb3J0IHsgQXdzUzNNb2R1bGUgfSBmcm9tIFwiLi4vc3JjL2F3c1MzTW9kdWxlXCI7XHJcbmltcG9ydCB7IEF6dXJlRGF0YUxha2VNb2R1bGUgfSBmcm9tIFwiLi4vc3JjL2F6dXJlRGF0YUxha2VNb2R1bGVcIjtcclxuaW1wb3J0IHsgY3JlYXRlRGlySWZOb3RFeGlzdHMsIGRlbGV0ZUZvbGRlciB9IGZyb20gXCIuLi9zcmMvZmlsZXNIZWxwZXJcIjtcclxuaW1wb3J0IHsgUmVkaXNNb2R1bGUsIFJlZGlzT2JqZWN0IH0gZnJvbSBcIi4uL3NyYy9yZWRpc01vZHVsZVwiO1xyXG5pbXBvcnQgeyBTM1RvQWRsRGF0YUNvcHkgfSBmcm9tIFwiLi4vc3JjL3MzVG9BZGxEYXRhQ29weVwiO1xyXG5cclxuZGVzY3JpYmUoXCJhd3MgczMgdGVzdHNcIiwgKCkgPT4ge1xyXG5cclxuICAgIGxldCBzM1RvQWRsOiBTM1RvQWRsRGF0YUNvcHk7XHJcbiAgICBsZXQgYWRsTW9kdWxlOiBBenVyZURhdGFMYWtlTW9kdWxlO1xyXG4gICAgbGV0IGF3c1MzTW9kdWxlOiBBd3NTM01vZHVsZTtcclxuICAgIGxldCByZWRpc01vZHVsZTogUmVkaXNNb2R1bGU7XHJcblxyXG4gICAgY29uc3QgZXhwZWN0ZWRFbGVtZW50MSA9IHtcclxuICAgICAgICBFVGFnOiBcIjEyMzQ1NlwiLFxyXG4gICAgICAgIEtleTogXCJmaWxlMVwiLFxyXG4gICAgfTtcclxuICAgIGNvbnN0IGV4cGVjdGVkRWxlbWVudDIgPSB7XHJcbiAgICAgICAgRVRhZzogXCIxMjM0NTdcIixcclxuICAgICAgICBLZXk6IFwiZmlsZTJcIixcclxuICAgIH07XHJcblxyXG4gICAgYmVmb3JlRWFjaChmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgcHJvY2Vzcy5lbnZbXCJBV1NfQUNDRVNTX0tFWV9JRFwiXSA9IFwia2V5XCI7XHJcbiAgICAgICAgcHJvY2Vzcy5lbnZbXCJBV1NfU0VDUkVUX0FDQ0VTU19LRVlcIl0gPSBcInNlY3JldGtleVwiO1xyXG4gICAgICAgIHByb2Nlc3MuZW52W1wiQVdTX1JFR0lPTlwiXSA9IFwicmVnaW9uXCI7XHJcbiAgICAgICAgcHJvY2Vzcy5lbnZbXCJBV1NfQlVDS0VUX05BTUVcIl0gPSBcImJ1Y2tldFwiO1xyXG4gICAgICAgIHByb2Nlc3MuZW52W1wiQVpVUkVfQ0xJRU5UX0lEXCJdID0gXCJjbGllbnRcIjtcclxuICAgICAgICBwcm9jZXNzLmVudltcIkFaVVJFX0RPTUFJTlwiXSA9IFwiZG9tYWluXCI7XHJcbiAgICAgICAgcHJvY2Vzcy5lbnZbXCJBWlVSRV9TRUNSRVRcIl0gPSBcInNlY3JldFwiO1xyXG4gICAgICAgIHByb2Nlc3MuZW52W1wiQVpVUkVfQURMX0FDQ09VTlRfTkFNRVwiXSA9IFwiYWNjb3VudFwiO1xyXG4gICAgICAgIHByb2Nlc3MuZW52W1wiVEVNUF9GT0xERVJcIl0gPSBcIi4vdGVtcEZvbGRlclwiO1xyXG4gICAgICAgIHByb2Nlc3MuZW52W1wiVVNFX1JFRElTXCJdID0gXCJmYWxzZVwiO1xyXG5cclxuICAgICAgICBjb25zdCBidWNrZXROYW1lID0gXCJidWNrZXRcIjtcclxuICAgICAgICBjb25zdCB0ZW1wRm9sZGVyID0gXCJ0ZW1wRm9sZGVyXCI7XHJcbiAgICAgICAgYXdzUzNNb2R1bGUgPSBuZXcgQXdzUzNNb2R1bGUoYnVja2V0TmFtZSwgdGVtcEZvbGRlciwgbmV3IEFXUy5TMygpKTtcclxuICAgICAgICBhZGxNb2R1bGUgPSBuZXcgQXp1cmVEYXRhTGFrZU1vZHVsZShcImFjY291bnROYW1lXCIsIFwiZm9sZGVyTmFtZVwiLCBudWxsLCBcImJ1Y2tldFwiKTtcclxuICAgIH0pO1xyXG5cclxuICAgIGl0KFwiV2hlbiByZXF1aXJlZCBlbnZpcm9ubWVudCB2YXJpYWJsZXMgYXJlIG1pc3NpbmcgZXhjZXB0aW9uIGlzIHRocm93blwiLCAoKSA9PiB7XHJcbiAgICAgICAgLy8gZ2l2ZW5cclxuICAgICAgICBkZWxldGUgcHJvY2Vzcy5lbnZbXCJBWlVSRV9BRExfQUNDT1VOVF9OQU1FXCJdO1xyXG5cclxuICAgICAgICAvLyBhY3RcclxuICAgICAgICB0cnkge1xyXG4gICAgICAgICAgICBzM1RvQWRsID0gbmV3IFMzVG9BZGxEYXRhQ29weSgpO1xyXG4gICAgICAgIH0gY2F0Y2ggKGV4KSB7XHJcbiAgICAgICAgICAgIC8vIGFzc2VydFxyXG4gICAgICAgICAgICBleHBlY3QoZXgubWVzc2FnZSkudG8uZXF1YWwoXCJFbnZpcm9ubWVudCBWYXJpYWJsZSBBWlVSRV9BRExfQUNDT1VOVF9OQU1FIGlzIG5vdCBkZWZpbmVkXCIpO1xyXG4gICAgICAgIH1cclxuICAgIH0pO1xyXG5cclxuICAgIGl0KFwiV2hlbiBVU0VfUkVESVMgaXMgc2V0IHRvIG90aGVyIHZhcmlhYmxlIHRoZW4gdHJ1ZS9mYWxzZSBleGNlcHRpb24gaXMgdGhyb3duXCIsICgpID0+IHtcclxuICAgICAgICAvLyBnaXZlblxyXG4gICAgICAgIHByb2Nlc3MuZW52W1wiVVNFX1JFRElTXCJdID0gXCJzb21lIHZhbHVlXCI7XHJcblxyXG4gICAgICAgIC8vIGFjdFxyXG4gICAgICAgIHRyeSB7XHJcbiAgICAgICAgICAgIHMzVG9BZGwgPSBuZXcgUzNUb0FkbERhdGFDb3B5KCk7XHJcbiAgICAgICAgfSBjYXRjaCAoZXgpIHtcclxuICAgICAgICAgICAgLy8gYXNzZXJ0XHJcbiAgICAgICAgICAgIGV4cGVjdChleC5tZXNzYWdlKS50by5lcXVhbChcIkVudmlyb25tZW50IFZhcmlhYmxlIFVTRV9SRURJUyBzaG91bGQgY29udGFpbiBib29sZWFuIHZhbHVlXCIpO1xyXG4gICAgICAgIH1cclxuICAgIH0pO1xyXG5cclxuICAgIGl0KFwiYmF0Y2hJdGVyYXRpb25PdmVyUzNJdGVtcyBkb2Vzbid0IHVwbG9hZHMgZmlsZSB3aGVuIGl0J3MgYWxyZWFkeSBleGlzdHNcIiwgYXN5bmMgKCkgPT4ge1xyXG4gICAgICAgIC8vIGdpdmVuXHJcbiAgICAgICAgc2lub24uc3R1Yihhd3NTM01vZHVsZSwgXCJsaXN0QWxsT2JqZWN0c1wiKS5yZXR1cm5zKHtcclxuICAgICAgICAgICAgQ29udGVudHM6IFtleHBlY3RlZEVsZW1lbnQxLCBleHBlY3RlZEVsZW1lbnQyXSxcclxuICAgICAgICB9KTtcclxuXHJcbiAgICAgICAgY29uc3QgdXBsb2FkVG9BZGxTdHViID0gc2lub24uc3R1YihhZGxNb2R1bGUsIFwic2hvdWxkVXBsb2FkVG9BRExcIikucmV0dXJucyhuZXcgUHJvbWlzZTxib29sZWFuPigocmVzb2x2ZSkgPT4ge1xyXG4gICAgICAgICAgICByZXNvbHZlKGZhbHNlKTtcclxuICAgICAgICB9KSk7XHJcblxyXG4gICAgICAgIGNvbnN0IGF3c1NweSA9IHNpbm9uLnNweShhd3NTM01vZHVsZSwgXCJkb3dubG9hZEZpbGVGcm9tUzNcIik7XHJcblxyXG4gICAgICAgIC8vIGFjdFxyXG4gICAgICAgIHMzVG9BZGwgPSBuZXcgUzNUb0FkbERhdGFDb3B5KCk7XHJcbiAgICAgICAgYXdhaXQgczNUb0FkbC5iYXRjaEl0ZXJhdGlvbk92ZXJTM0l0ZW1zKGF3c1MzTW9kdWxlLCBhZGxNb2R1bGUsIG51bGwpO1xyXG5cclxuICAgICAgICAvLyBhc3NlcnRcclxuICAgICAgICBleHBlY3QoYXdzU3B5LmNhbGxDb3VudCkudG8uZXF1YWwoMCk7XHJcbiAgICAgICAgZXhwZWN0KHVwbG9hZFRvQWRsU3R1Yi5jYWxsQ291bnQpLnRvLmVxdWFsKDIpO1xyXG4gICAgfSk7XHJcblxyXG4gICAgaXQoXCJiYXRjaEl0ZXJhdGlvbk92ZXJTM0l0ZW1zIHVwbG9hZHMgdGhlIG1pc3NpbmcgZmlsZSBpbiBBRExcIiwgYXN5bmMgKCkgPT4ge1xyXG4gICAgICAgIC8vIGdpdmVuXHJcbiAgICAgICAgc2lub24uc3R1Yihhd3NTM01vZHVsZSwgXCJsaXN0QWxsT2JqZWN0c1wiKS5yZXR1cm5zKHtcclxuICAgICAgICAgICAgQ29udGVudHM6IFtleHBlY3RlZEVsZW1lbnQxLCBleHBlY3RlZEVsZW1lbnQyXSxcclxuICAgICAgICB9KTtcclxuICAgICAgICBsZXQgZG93bmxvYWRTdHViID0gc2lub24uc3R1Yihhd3NTM01vZHVsZSwgXCJkb3dubG9hZEZpbGVGcm9tUzNcIikucmV0dXJucyhuZXcgUHJvbWlzZSgocmVzb2x2ZSkgPT4gcmVzb2x2ZSgpKSk7XHJcbiAgICAgICAgc2lub24uc3R1YihhZGxNb2R1bGUsIFwidXBsb2FkRmlsZVRvQXp1cmVEYXRhTGFrZVwiKS5yZXR1cm5zKG5ldyBQcm9taXNlKChyZXNvbHZlKSA9PiByZXNvbHZlKCkpKTtcclxuXHJcbiAgICAgICAgY29uc3QgdXBsb2FkU3R1YiA9IHNpbm9uLnN0dWIoYWRsTW9kdWxlLCBcInNob3VsZFVwbG9hZFRvQURMXCIpO1xyXG4gICAgICAgIHVwbG9hZFN0dWIud2l0aEFyZ3MoZXhwZWN0ZWRFbGVtZW50MSkucmV0dXJucyhuZXcgUHJvbWlzZTxib29sZWFuPigocmVzb2x2ZSkgPT4ge1xyXG4gICAgICAgICAgICByZXNvbHZlKGZhbHNlKTtcclxuICAgICAgICB9KSk7XHJcbiAgICAgICAgdXBsb2FkU3R1Yi53aXRoQXJncyhleHBlY3RlZEVsZW1lbnQyKS5yZXR1cm5zKG5ldyBQcm9taXNlPGJvb2xlYW4+KChyZXNvbHZlKSA9PiB7XHJcbiAgICAgICAgICAgIHJlc29sdmUodHJ1ZSk7XHJcbiAgICAgICAgfSkpO1xyXG5cclxuICAgICAgICAvLyBhY3RcclxuICAgICAgICBzM1RvQWRsID0gbmV3IFMzVG9BZGxEYXRhQ29weSgpO1xyXG4gICAgICAgIGF3YWl0IHMzVG9BZGwuYmF0Y2hJdGVyYXRpb25PdmVyUzNJdGVtcyhhd3NTM01vZHVsZSwgYWRsTW9kdWxlLCBudWxsKTtcclxuXHJcbiAgICAgICAgLy8gYXNzZXJ0XHJcbiAgICAgICAgZXhwZWN0KGRvd25sb2FkU3R1Yi5jYWxsQ291bnQpLnRvLmVxdWFsKDEpO1xyXG4gICAgICAgIGV4cGVjdCh1cGxvYWRTdHViLmNhbGxDb3VudCkudG8uZXF1YWwoMik7XHJcbiAgICB9KTtcclxuXHJcbiAgICBpdChcImJhdGNoSXRlcmF0aW9uT3ZlclMzSXRlbXMgd2hlbiBlcnJvciBpcyB0aHJvd24gd2hpbGUgdXBsb2FkaW5nIGZpbGUgaXRlcmF0aW9uIGNvbnRpbnVlcyBhcyBleHBlY3RlZFwiLCBhc3luYyAoKSA9PiB7XHJcbiAgICAgICAgLy8gZ2l2ZW5cclxuICAgICAgICBzaW5vbi5zdHViKGF3c1MzTW9kdWxlLCBcImxpc3RBbGxPYmplY3RzXCIpLnJldHVybnMoe1xyXG4gICAgICAgICAgICBDb250ZW50czogW2V4cGVjdGVkRWxlbWVudDEsIGV4cGVjdGVkRWxlbWVudDJdLFxyXG4gICAgICAgIH0pO1xyXG5cclxuICAgICAgICBsZXQgZG93bmxvYWRTdHViID0gc2lub24uc3R1Yihhd3NTM01vZHVsZSwgXCJkb3dubG9hZEZpbGVGcm9tUzNcIikucmV0dXJucyhuZXcgUHJvbWlzZSgocmVzb2x2ZSkgPT4gcmVzb2x2ZSgpKSk7XHJcbiAgICAgICAgbGV0IHVwbG9hZFN0dWIgPSBzaW5vbi5zdHViKGFkbE1vZHVsZSwgXCJ1cGxvYWRGaWxlVG9BenVyZURhdGFMYWtlXCIpO1xyXG4gICAgICAgIHVwbG9hZFN0dWIud2l0aEFyZ3MoZXhwZWN0ZWRFbGVtZW50MS5LZXkpLnRocm93cyhuZXcgRXJyb3IoKSk7XHJcbiAgICAgICAgdXBsb2FkU3R1Yi53aXRoQXJncyhleHBlY3RlZEVsZW1lbnQyLktleSkucmV0dXJucyhuZXcgUHJvbWlzZSgocmVzb2x2ZSkgPT4gcmVzb2x2ZSgpKSk7XHJcblxyXG4gICAgICAgIGNvbnN0IHNob3VsZFVwbG9hZFN0dWIgPSBzaW5vbi5zdHViKGFkbE1vZHVsZSwgXCJzaG91bGRVcGxvYWRUb0FETFwiKS5yZXR1cm5zKG5ldyBQcm9taXNlPGJvb2xlYW4+KChyZXNvbHZlKSA9PiB7XHJcbiAgICAgICAgICAgIHJlc29sdmUodHJ1ZSk7XHJcbiAgICAgICAgfSkpO1xyXG5cclxuICAgICAgICAvLyBhY3RcclxuICAgICAgICBzM1RvQWRsID0gbmV3IFMzVG9BZGxEYXRhQ29weSgpO1xyXG4gICAgICAgIGF3YWl0IHMzVG9BZGwuYmF0Y2hJdGVyYXRpb25PdmVyUzNJdGVtcyhhd3NTM01vZHVsZSwgYWRsTW9kdWxlLCBudWxsKTtcclxuXHJcbiAgICAgICAgLy8gYXNzZXJ0XHJcbiAgICAgICAgZXhwZWN0KGRvd25sb2FkU3R1Yi5jYWxsQ291bnQpLnRvLmVxdWFsKDIpO1xyXG4gICAgICAgIGV4cGVjdChzaG91bGRVcGxvYWRTdHViLmNhbGxDb3VudCkudG8uZXF1YWwoMik7XHJcbiAgICAgICAgLy8gZXhwZWN0IG9ubHkgb25lIHNpbmNlIHRoZSBzZWNvbmQgdGhyb3duIGFuIGVycm9yXHJcbiAgICAgICAgZXhwZWN0KHMzVG9BZGwuY29weVByb3BlcnRpZXMudXBsb2FkZWRDb3VudCkudG8uZXF1YWwoMSk7XHJcbiAgICB9KTtcclxuXHJcbiAgICBpdChcInNob3VsZFVwbG9hZEZpbGUgcmV0dXJuIGZhbHNlIHdoZW4gdXNpbmcgcmVkaXMgYW5kIGZpbGUgZXhpc3Qgb24gQURMXCIsIGFzeW5jICgpID0+IHtcclxuICAgICAgICAvLyBnaXZlblxyXG4gICAgICAgIHByb2Nlc3MuZW52W1wiVVNFX1JFRElTXCJdID0gXCJ0cnVlXCI7XHJcbiAgICAgICAgY29uc3QgcmVkaXNPYmogPSBuZXcgUmVkaXNPYmplY3QoKTtcclxuICAgICAgICByZWRpc09iai5FVGFnID0gZXhwZWN0ZWRFbGVtZW50MS5FVGFnO1xyXG4gICAgICAgIHJlZGlzTW9kdWxlID0gbmV3IFJlZGlzTW9kdWxlKG51bGwpO1xyXG4gICAgICAgIGNvbnN0IHNob3VsZFVwbG9hZFN0dWIgPSBzaW5vbi5zdHViKHJlZGlzTW9kdWxlLCBcImlzRmlsZUluUmVkaXNcIikucmV0dXJucyhuZXcgUHJvbWlzZTxSZWRpc09iamVjdD4oKHJlc29sdmUpID0+IHtcclxuICAgICAgICAgICAgcmVzb2x2ZShyZWRpc09iaik7XHJcbiAgICAgICAgfSkpO1xyXG5cclxuICAgICAgICAvLyBhY3RcclxuICAgICAgICBzM1RvQWRsID0gbmV3IFMzVG9BZGxEYXRhQ29weSgpO1xyXG4gICAgICAgIGxldCBzaG91bGRVcGxvYWQgPSBhd2FpdCBzM1RvQWRsLnNob3VsZFVwbG9hZEZpbGUocmVkaXNNb2R1bGUsIGFkbE1vZHVsZSwgZXhwZWN0ZWRFbGVtZW50MSk7XHJcblxyXG4gICAgICAgIC8vIGFzc2VydFxyXG4gICAgICAgIGV4cGVjdChzaG91bGRVcGxvYWRTdHViLmNhbGxDb3VudCkudG8uZXF1YWwoMSk7XHJcbiAgICAgICAgLy8gZXhwZWN0IG9ubHkgb25lIHNpbmNlIHRoZSBzZWNvbmQgdGhyb3duIGFuIGVycm9yXHJcbiAgICAgICAgZXhwZWN0KHNob3VsZFVwbG9hZCkudG8uZXF1YWwoZmFsc2UpO1xyXG4gICAgfSk7XHJcblxyXG4gICAgaXQoXCJzaG91bGRVcGxvYWRGaWxlIHJldHVybiB0cnVlIHdoZW4gdXNpbmcgcmVkaXMgYW5kIGZpbGUgaXMgbWlzc2luZyBmcm9tIEFETFwiLCBhc3luYyAoKSA9PiB7XHJcbiAgICAgICAgLy8gZ2l2ZW5cclxuICAgICAgICBwcm9jZXNzLmVudltcIlVTRV9SRURJU1wiXSA9IFwidHJ1ZVwiO1xyXG4gICAgICAgIGNvbnN0IHJlZGlzT2JqID0gbmV3IFJlZGlzT2JqZWN0KCk7XHJcbiAgICAgICAgcmVkaXNPYmouRVRhZyA9IFwiNjU0MzMyMVwiO1xyXG4gICAgICAgIHJlZGlzTW9kdWxlID0gbmV3IFJlZGlzTW9kdWxlKG51bGwpO1xyXG4gICAgICAgIGNvbnN0IHNob3VsZFVwbG9hZFN0dWIgPSBzaW5vbi5zdHViKHJlZGlzTW9kdWxlLCBcImlzRmlsZUluUmVkaXNcIikucmV0dXJucyhuZXcgUHJvbWlzZTxSZWRpc09iamVjdD4oKHJlc29sdmUpID0+IHtcclxuICAgICAgICAgICAgcmVzb2x2ZShyZWRpc09iaik7XHJcbiAgICAgICAgfSkpO1xyXG5cclxuICAgICAgICAvLyBhY3RcclxuICAgICAgICBzM1RvQWRsID0gbmV3IFMzVG9BZGxEYXRhQ29weSgpO1xyXG4gICAgICAgIGxldCBzaG91bGRVcGxvYWQgPSBhd2FpdCBzM1RvQWRsLnNob3VsZFVwbG9hZEZpbGUocmVkaXNNb2R1bGUsIGFkbE1vZHVsZSwgZXhwZWN0ZWRFbGVtZW50MSk7XHJcblxyXG4gICAgICAgIC8vIGFzc2VydFxyXG4gICAgICAgIGV4cGVjdChzaG91bGRVcGxvYWRTdHViLmNhbGxDb3VudCkudG8uZXF1YWwoMSk7XHJcbiAgICAgICAgLy8gZXhwZWN0IG9ubHkgb25lIHNpbmNlIHRoZSBzZWNvbmQgdGhyb3duIGFuIGVycm9yXHJcbiAgICAgICAgZXhwZWN0KHNob3VsZFVwbG9hZCkudG8uZXF1YWwodHJ1ZSk7XHJcbiAgICB9KTtcclxuXHJcbiAgICBpdChcInNob3VsZFVwbG9hZEZpbGUgcmV0dXJuIHRydWUgYW5kIG5vdCB1cGRhdGUgcmVkaXMgd2hlbiByZWRpcyBpcyBlbXB0eSBhbmQgZmlsZSBleGlzdCBvbiBBRExcIiwgYXN5bmMgKCkgPT4ge1xyXG4gICAgICAgIC8vIGdpdmVuXHJcbiAgICAgICAgcHJvY2Vzcy5lbnZbXCJVU0VfUkVESVNcIl0gPSBcInRydWVcIjtcclxuICAgICAgICByZWRpc01vZHVsZSA9IG5ldyBSZWRpc01vZHVsZShudWxsKTtcclxuICAgICAgICBjb25zdCBpc0ZpbGVJblJlZGlzU3R1YiA9IHNpbm9uLnN0dWIocmVkaXNNb2R1bGUsIFwiaXNGaWxlSW5SZWRpc1wiKS5yZXR1cm5zKG5ldyBQcm9taXNlPFJlZGlzT2JqZWN0PigocmVzb2x2ZSkgPT4ge1xyXG4gICAgICAgICAgICByZXNvbHZlKG51bGwpO1xyXG4gICAgICAgIH0pKTtcclxuXHJcbiAgICAgICAgY29uc3QgYWRkRmlsZVRvUmVkaXNTdHViID0gc2lub24uc3R1YihyZWRpc01vZHVsZSwgXCJhZGRGaWxlVG9SZWRpc1wiKS5yZXR1cm5zKG5ldyBQcm9taXNlPFJlZGlzT2JqZWN0PigocmVzb2x2ZSkgPT4ge1xyXG4gICAgICAgICAgICByZXNvbHZlKCk7XHJcbiAgICAgICAgfSkpO1xyXG4gICAgICAgIGNvbnN0IHVwbG9hZFRvQWRsU3R1YiA9IHNpbm9uLnN0dWIoYWRsTW9kdWxlLCBcInNob3VsZFVwbG9hZFRvQURMXCIpLnJldHVybnMobmV3IFByb21pc2U8Ym9vbGVhbj4oKHJlc29sdmUpID0+IHtcclxuICAgICAgICAgICAgcmVzb2x2ZShmYWxzZSk7XHJcbiAgICAgICAgfSkpO1xyXG5cclxuICAgICAgICAvLyBhY3RcclxuICAgICAgICBzM1RvQWRsID0gbmV3IFMzVG9BZGxEYXRhQ29weSgpO1xyXG4gICAgICAgIGxldCBzaG91bGRVcGxvYWQgPSBhd2FpdCBzM1RvQWRsLnNob3VsZFVwbG9hZEZpbGUocmVkaXNNb2R1bGUsIGFkbE1vZHVsZSwgZXhwZWN0ZWRFbGVtZW50MSk7XHJcblxyXG4gICAgICAgIC8vIGFzc2VydFxyXG4gICAgICAgIGV4cGVjdChpc0ZpbGVJblJlZGlzU3R1Yi5jYWxsQ291bnQpLnRvLmVxdWFsKDEpO1xyXG4gICAgICAgIGV4cGVjdChzaG91bGRVcGxvYWQpLnRvLmVxdWFsKGZhbHNlKTtcclxuICAgICAgICBleHBlY3QoYWRkRmlsZVRvUmVkaXNTdHViLmNhbGxDb3VudCkudG8uZXF1YWwoMSk7XHJcbiAgICB9KTtcclxuXHJcbiAgICBpdChcInNob3VsZFVwbG9hZEZpbGUgcmV0dXJuIHRydWUgYW5kIHVwZGF0ZSByZWRpcyB3aGVuIHJlZGlzIGlzIGVtcHR5IGFuZCBmaWxlIGV4aXN0IG9uIEFETFwiLCBhc3luYyAoKSA9PiB7XHJcbiAgICAgICAgLy8gZ2l2ZW5cclxuICAgICAgICBwcm9jZXNzLmVudltcIlVTRV9SRURJU1wiXSA9IFwidHJ1ZVwiO1xyXG4gICAgICAgIHJlZGlzTW9kdWxlID0gbmV3IFJlZGlzTW9kdWxlKG51bGwpO1xyXG4gICAgICAgIGNvbnN0IGlzRmlsZUluUmVkaXNTdHViID0gc2lub24uc3R1YihyZWRpc01vZHVsZSwgXCJpc0ZpbGVJblJlZGlzXCIpLnJldHVybnMobmV3IFByb21pc2U8UmVkaXNPYmplY3Q+KChyZXNvbHZlKSA9PiB7XHJcbiAgICAgICAgICAgIHJlc29sdmUobnVsbCk7XHJcbiAgICAgICAgfSkpO1xyXG5cclxuICAgICAgICBjb25zdCBhZGRGaWxlVG9SZWRpc1N0dWIgPSBzaW5vbi5zdHViKHJlZGlzTW9kdWxlLCBcImFkZEZpbGVUb1JlZGlzXCIpO1xyXG4gICAgICAgIGNvbnN0IHVwbG9hZFRvQWRsU3R1YiA9IHNpbm9uLnN0dWIoYWRsTW9kdWxlLCBcInNob3VsZFVwbG9hZFRvQURMXCIpLnJldHVybnMobmV3IFByb21pc2U8Ym9vbGVhbj4oKHJlc29sdmUpID0+IHtcclxuICAgICAgICAgICAgcmVzb2x2ZSh0cnVlKTtcclxuICAgICAgICB9KSk7XHJcblxyXG4gICAgICAgIC8vIGFjdFxyXG4gICAgICAgIHMzVG9BZGwgPSBuZXcgUzNUb0FkbERhdGFDb3B5KCk7XHJcbiAgICAgICAgbGV0IHNob3VsZFVwbG9hZCA9IGF3YWl0IHMzVG9BZGwuc2hvdWxkVXBsb2FkRmlsZShyZWRpc01vZHVsZSwgYWRsTW9kdWxlLCBleHBlY3RlZEVsZW1lbnQxKTtcclxuXHJcbiAgICAgICAgLy8gYXNzZXJ0XHJcbiAgICAgICAgZXhwZWN0KGlzRmlsZUluUmVkaXNTdHViLmNhbGxDb3VudCkudG8uZXF1YWwoMSk7XHJcbiAgICAgICAgZXhwZWN0KHNob3VsZFVwbG9hZCkudG8uZXF1YWwodHJ1ZSk7XHJcbiAgICAgICAgZXhwZWN0KGFkZEZpbGVUb1JlZGlzU3R1Yi5jYWxsQ291bnQpLnRvLmVxdWFsKDApO1xyXG4gICAgfSk7XHJcbn0pOyJdLCJzb3VyY2VSb290IjoiLi4ifQ==
